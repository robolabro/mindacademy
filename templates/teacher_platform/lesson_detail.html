{% extends 'teacher_platform/base_teacher.html' %}

{% block title %}Lec»õie {{ lesson.date|date:"d M Y" }}{% endblock %}
{% block page_title %}üìö Lec»õie - {{ lesson.group.name }}{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="{% url 'teacher_platform:calendar' %}">Calendar</a>
        <span>/</span>
        <a href="{% url 'teacher_platform:group_detail' lesson.group.id %}">{{ lesson.group.name }}</a>
        <span>/</span>
        <span>Lec»õie {{ lesson.date|date:"d M Y" }}</span>
    </div>

    <!-- Lesson Overview -->
    <div class="detail-card">
        <div class="detail-header">
            <div>
                <h2>
                    {% if lesson.lesson_template %}
                        {{ lesson.lesson_template.name }}
                    {% elif lesson.topic %}
                        {{ lesson.topic }}
                    {% else %}
                        Lec»õie {{ lesson.date|date:"d M Y" }}
                    {% endif %}
                </h2>
                <span class="lesson-status-badge status-{{ lesson.status }}">{{ lesson.get_status_display }}</span>
            </div>
            <div class="header-actions">
                <a href="{% url 'teacher_platform:lesson_edit' lesson.id %}" class="btn-secondary">EditeazƒÉ Lec»õie</a>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">üë• GrupƒÉ:</span>
                <span class="info-value">
                    <a href="{% url 'teacher_platform:group_detail' lesson.group.id %}">{{ lesson.group.name }}</a>
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">üìÖ Data:</span>
                <span class="info-value">{{ lesson.date|date:"l, d F Y" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">üïê OrƒÉ:</span>
                <span class="info-value">
                    {{ lesson.start_time|date:"H:i" }}
                    {% if lesson.end_time %} - {{ lesson.end_time|date:"H:i" }}{% endif %}
                </span>
            </div>
            {% if lesson.group.module %}
            <div class="info-item">
                <span class="info-label">üìñ Modul:</span>
                <span class="info-value">
                    <span class="module-badge" style="background-color: {{ lesson.group.module.color }}20; color: {{ lesson.group.module.color }};">
                        {{ lesson.group.module.name }}
                    </span>
                </span>
            </div>
            {% endif %}
        </div>

        {% if lesson.description %}
        <div class="lesson-section">
            <h3>Descriere</h3>
            <p>{{ lesson.description }}</p>
        </div>
        {% endif %}

        {% if lesson.homework %}
        <div class="lesson-section">
            <h3>TemƒÉ pentru AcasƒÉ</h3>
            <p>{{ lesson.homework }}</p>
        </div>
        {% endif %}

        {% if lesson.teacher_notes %}
        <div class="lesson-section">
            <h3>Noti»õe Profesor</h3>
            <p>{{ lesson.teacher_notes }}</p>
        </div>
        {% endif %}

        {% if lesson.lesson_template and lesson.lesson_template.lesson_plan_file %}
        <div class="lesson-section">
            <h3>Plan de Lec»õie</h3>
            <a href="{{ lesson.lesson_template.lesson_plan_file.url }}" target="_blank" class="btn-secondary">üìÑ Vezi Plan de Lec»õie</a>
        </div>
        {% endif %}
    </div>

    <!-- Attendance Tracking -->
    <div class="detail-card">
        <div class="card-header">
            <h2>üìä Prezen»õƒÉ Studen»õi</h2>
            <div class="attendance-summary">
                {% with present_count=students_data|length %}
                <span>Studen»õi √Æn grupƒÉ: {{ present_count }}</span>
                {% endwith %}
            </div>
        </div>

        <div class="card-body">
            {% if students_data %}
            <div class="attendance-table">
                <table>
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Prezen»õƒÉ</th>
                            <th>Performan»õƒÉ</th>
                            <th>Observa»õii</th>
                            <th>Ac»õiuni</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in students_data %}
                        <tr data-student-id="{{ data.student.id }}" class="attendance-row">
                            <td>
                                <a href="{% url 'teacher_platform:student_detail' data.student.id %}" class="student-link">
                                    {{ data.student.get_full_name }}
                                </a>
                            </td>
                            <td>
                                <span class="attendance-status">
                                    {% if data.attendance %}
                                        {% if data.attendance.is_present %}
                                            <span class="status-badge status-present">‚úì Prezent</span>
                                        {% else %}
                                            <span class="status-badge status-absent">‚úó Absent</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="status-badge status-pending">‚äù Nemarcat</span>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="performance-display">
                                    {% if data.attendance and data.attendance.performance_rating %}
                                        <div class="performance-stars">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= data.attendance.performance_rating %}‚≠ê{% else %}‚òÜ{% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="notes-display">
                                    {% if data.attendance and data.attendance.notes %}
                                        <span class="notes-preview">{{ data.attendance.notes|truncatewords:10 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <button class="btn-small btn-edit-attendance"
                                        data-student-id="{{ data.student.id }}"
                                        data-student-name="{{ data.student.get_full_name }}"
                                        data-is-present="{{ data.attendance.is_present|default:'false' }}"
                                        data-performance="{{ data.attendance.performance_rating|default:'' }}"
                                        data-notes="{{ data.attendance.notes|default:'' }}">
                                    {% if data.attendance %}üìù EditeazƒÉ{% else %}‚úì MarcheazƒÉ{% endif %}
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <p>Nu sunt studen»õi √Ænscri»ôi √Æn aceastƒÉ grupƒÉ.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal pentru marcarea prezen»õei -->
<div id="attendanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>MarcheazƒÉ Prezen»õƒÉ</h3>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="attendanceForm">
                <input type="hidden" id="student_id" name="student_id">

                <div class="form-group">
                    <label class="student-name-label"></label>
                </div>

                <div class="form-group">
                    <label>Prezen»õƒÉ *</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="is_present" value="true" required>
                            <span>‚úì Prezent</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="is_present" value="false" required>
                            <span>‚úó Absent</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="performance_rating">Performan»õƒÉ (1-5 stele)</label>
                    <div class="star-rating">
                        <input type="radio" name="performance_rating" value="5" id="star5">
                        <label for="star5">‚≠ê</label>
                        <input type="radio" name="performance_rating" value="4" id="star4">
                        <label for="star4">‚≠ê</label>
                        <input type="radio" name="performance_rating" value="3" id="star3">
                        <label for="star3">‚≠ê</label>
                        <input type="radio" name="performance_rating" value="2" id="star2">
                        <label for="star2">‚≠ê</label>
                        <input type="radio" name="performance_rating" value="1" id="star1">
                        <label for="star1">‚≠ê</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Observa»õii</label>
                    <textarea id="notes" name="notes" class="form-control" rows="3" placeholder="Noti»õe despre comportament, progres, etc."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">üíæ SalveazƒÉ</button>
                    <button type="button" class="btn-secondary modal-cancel">AnuleazƒÉ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('attendanceModal');
    const closeBtn = modal.querySelector('.modal-close');
    const cancelBtn = modal.querySelector('.modal-cancel');
    const form = document.getElementById('attendanceForm');
    const editButtons = document.querySelectorAll('.btn-edit-attendance');

    // Deschide modalul
    editButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const studentId = this.dataset.studentId;
            const studentName = this.dataset.studentName;
            const isPresent = this.dataset.isPresent;
            const performance = this.dataset.performance;
            const notes = this.dataset.notes;

            // PopuleazƒÉ formularul
            document.getElementById('student_id').value = studentId;
            modal.querySelector('.student-name-label').textContent = studentName;

            // SeteazƒÉ prezen»õa
            const presentRadio = document.querySelector('input[name="is_present"][value="true"]');
            const absentRadio = document.querySelector('input[name="is_present"][value="false"]');
            if (isPresent === 'True') {
                presentRadio.checked = true;
            } else if (isPresent === 'False') {
                absentRadio.checked = true;
            }

            // SeteazƒÉ performan»õa
            document.querySelectorAll('input[name="performance_rating"]').forEach(r => r.checked = false);
            if (performance) {
                const perfRadio = document.querySelector(`input[name="performance_rating"][value="${performance}"]`);
                if (perfRadio) perfRadio.checked = true;
            }

            // SeteazƒÉ noti»õele
            document.getElementById('notes').value = notes || '';

            // AratƒÉ modalul
            modal.style.display = 'block';
        });
    });

    // √énchide modalul
    function closeModal() {
        modal.style.display = 'none';
        form.reset();
    }

    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    // Trimite formularul
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "teacher_platform:mark_attendance" lesson.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // ActualizeazƒÉ UI-ul
                const studentId = formData.get('student_id');
                const row = document.querySelector(`tr[data-student-id="${studentId}"]`);

                const isPresent = formData.get('is_present') === 'true';
                const performance = formData.get('performance_rating');
                const notes = formData.get('notes');

                // ActualizeazƒÉ status prezen»õƒÉ
                const statusHtml = isPresent
                    ? '<span class="status-badge status-present">‚úì Prezent</span>'
                    : '<span class="status-badge status-absent">‚úó Absent</span>';
                row.querySelector('.attendance-status').innerHTML = statusHtml;

                // ActualizeazƒÉ performan»õƒÉ
                let perfHtml = '<span class="text-muted">-</span>';
                if (performance) {
                    const stars = parseInt(performance);
                    perfHtml = '<div class="performance-stars">';
                    for (let i = 1; i <= 5; i++) {
                        perfHtml += i <= stars ? '‚≠ê' : '‚òÜ';
                    }
                    perfHtml += '</div>';
                }
                row.querySelector('.performance-display').innerHTML = perfHtml;

                // ActualizeazƒÉ noti»õe
                const notesHtml = notes
                    ? `<span class="notes-preview">${notes.substring(0, 50)}${notes.length > 50 ? '...' : ''}</span>`
                    : '<span class="text-muted">-</span>';
                row.querySelector('.notes-display').innerHTML = notesHtml;

                // ActualizeazƒÉ butonul
                row.querySelector('.btn-edit-attendance').textContent = 'üìù EditeazƒÉ';

                // √énchide modalul
                closeModal();

                // Mesaj de succes
                alert('Prezen»õa a fost salvatƒÉ cu succes!');
            } else {
                alert('Eroare: ' + (data.error || 'Nu s-a putut salva prezen»õa'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('A apƒÉrut o eroare la salvarea prezen»õei');
        });
    });
});
</script>

<style>
/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.2s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    animation: slideDown 0.3s;
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 20px 30px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.modal-close {
    font-size: 28px;
    font-weight: bold;
    color: #999;
    cursor: pointer;
    transition: color 0.2s;
}

.modal-close:hover {
    color: #333;
}

.modal-body {
    padding: 30px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
}

.student-name-label {
    font-size: 16px;
    color: #667eea;
    padding: 10px;
    background: rgba(102,126,234,0.1);
    border-radius: 6px;
}

.radio-group {
    display: flex;
    gap: 12px;
}

.radio-label {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.radio-label:hover {
    border-color: #667eea;
    background: #f8f9fa;
}

.radio-label input[type="radio"] {
    margin-right: 8px;
    cursor: pointer;
}

.radio-label:has(input:checked) {
    border-color: #667eea;
    background: rgba(102,126,234,0.1);
    font-weight: 600;
}

.star-rating {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 5px;
}

.star-rating input[type="radio"] {
    display: none;
}

.star-rating label {
    font-size: 30px;
    cursor: pointer;
    transition: all 0.2s;
    opacity: 0.3;
}

.star-rating input[type="radio"]:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
    opacity: 1;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn-small {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    background: #667eea;
    color: white;
    transition: all 0.2s;
}

.btn-small:hover {
    background: #5568d3;
    transform: translateY(-1px);
}

.btn-edit-attendance {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    background: #667eea;
    color: white;
    transition: all 0.2s;
}

.btn-edit-attendance:hover {
    background: #5568d3;
    transform: translateY(-1px);
}
</style>
{% endblock %}
