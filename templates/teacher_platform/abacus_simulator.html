{% extends 'teacher_platform/base_teacher.html' %}

{% block title %}Simulator Abac{% endblock %}
{% block page_title %}Abac Online{% endblock %}

{% block extra_css %}
<style>
    .abacus-container {
        padding: 2rem;
        max-width: 100%;
        height: calc(100vh - 180px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    /* Configuration Dialog */
    .config-dialog {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        max-width: 500px;
        width: 90%;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .config-title {
        text-align: center;
        font-size: 1.8rem;
        color: var(--text-color);
        margin-bottom: 2rem;
        font-weight: 600;
    }

    .config-option {
        margin-bottom: 2rem;
    }

    .config-label {
        display: block;
        font-size: 1rem;
        color: var(--text-color);
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .size-options {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .size-btn {
        width: 80px;
        height: 80px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        background: white;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .size-btn:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .size-btn.active {
        background: var(--gradient-primary);
        color: white;
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .toggle-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
        background: #e0e0e0;
        border-radius: 30px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .toggle-switch.active {
        background: var(--primary-color);
    }

    .toggle-knob {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 24px;
        height: 24px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-knob {
        transform: translateX(30px);
    }

    .start-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #ff0844 0%, #ff6b9d 100%);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
    }

    .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 8, 68, 0.4);
    }

    /* Abacus Display */
    .abacus-display {
        display: none;
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        animation: fadeIn 0.5s ease;
        max-width: 95%;
        overflow-x: auto;
    }

    .abacus-display.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .abacus-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .result-display {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .control-buttons {
        display: flex;
        gap: 1rem;
    }

    .clear-btn, .back-btn {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .clear-btn {
        background: linear-gradient(135deg, #ff0844 0%, #ff6b9d 100%);
        color: white;
    }

    .clear-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 8, 68, 0.3);
    }

    .back-btn {
        background: #f0f0f0;
        color: var(--text-color);
    }

    .back-btn:hover {
        background: #e0e0e0;
        transform: translateY(-2px);
    }

    /* Abacus Structure */
    .abacus-frame {
        background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        margin-top: 1rem;
    }

    .counters-row {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 1rem;
        padding: 0;
    }

    .counter {
        width: 50px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        background: white;
        border-radius: 8px;
        padding: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .abacus-rods {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        position: relative;
    }

    .rod-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .place-label {
        position: absolute;
        top: -30px;
        font-size: 0.75rem;
        color: #666;
        font-weight: 600;
        white-space: nowrap;
    }

    .rod {
        width: 8px;
        height: 320px;
        background: linear-gradient(to bottom, #555 0%, #333 100%);
        border-radius: 4px;
        position: relative;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .divider {
        position: absolute;
        left: 50%;
        top: 17%;
        transform: translate(-50%, -50%);
        width: calc(100% + 40px);
        height: 6px;
        background: linear-gradient(135deg, #333 0%, #555 100%);
        border-radius: 3px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        z-index: 10;
    }

    .beads-section {
        position: absolute;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .beads-section.top {
        top: 0;
        padding-top: 10px;
    }

    .beads-section.bottom {
        bottom: 0;
        padding-bottom: 10px;
    }

    .bead {
        width: 45px;
        height: 55px;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        border-radius: 50%;
        margin: 2px 0;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .bead::before {
        content: '';
        position: absolute;
        width: 70%;
        height: 70%;
        background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), transparent);
        border-radius: 50%;
        top: 10%;
        left: 10%;
    }

    .bead:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(255, 165, 0, 0.5);
    }

    .bead.active {
        background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        box-shadow: 0 4px 12px rgba(255, 140, 0, 0.6);
    }

    @media (max-width: 768px) {
        .abacus-container {
            padding: 1rem;
        }

        .config-dialog {
            padding: 1.5rem;
        }

        .size-btn {
            width: 60px;
            height: 60px;
            font-size: 1.2rem;
        }

        .result-display {
            font-size: 1.5rem;
        }

        .counter {
            width: 40px;
            font-size: 1.2rem;
        }

        .bead {
            width: 35px;
            height: 45px;
        }

        .rod {
            width: 6px;
            height: 280px;
        }
    }

    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="abacus-container">
    <!-- Configuration Dialog -->
    <div class="config-dialog" id="configDialog">
        <h2 class="config-title">Configurare Abac</h2>

        <div class="config-option">
            <label class="config-label">Abacus size</label>
            <div class="size-options">
                <button class="size-btn" data-size="7">7</button>
                <button class="size-btn active" data-size="15">15</button>
                <button class="size-btn" data-size="17">17</button>
            </div>
        </div>

        <div class="config-option">
            <div class="toggle-option">
                <label class="config-label" style="margin-bottom: 0;">Show the result:</label>
                <div class="toggle-switch active" id="toggleResult">
                    <div class="toggle-knob"></div>
                </div>
            </div>
        </div>

        <button class="start-btn" id="startBtn">Start</button>
    </div>

    <!-- Abacus Display -->
    <div class="abacus-display" id="abacusDisplay">
        <div class="abacus-header">
            <div class="result-display" id="resultDisplay">Total: 0</div>
            <div class="control-buttons">
                <button class="back-btn" id="backBtn">← Back</button>
                <button class="clear-btn" id="clearBtn">Clear</button>
            </div>
        </div>

        <div class="abacus-frame">
            <div class="counters-row" id="countersRow"></div>
            <div class="abacus-rods" id="abacusRods"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Configuration variables
    let abacusSize = 15;
    let showResult = true;
    let columnValues = [];

    // DOM Elements
    const configDialog = document.getElementById('configDialog');
    const abacusDisplay = document.getElementById('abacusDisplay');
    const startBtn = document.getElementById('startBtn');
    const backBtn = document.getElementById('backBtn');
    const clearBtn = document.getElementById('clearBtn');
    const toggleResult = document.getElementById('toggleResult');
    const resultDisplay = document.getElementById('resultDisplay');
    const sizeBtns = document.querySelectorAll('.size-btn');

    // Configuration: Size selection
    sizeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            sizeBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            abacusSize = parseInt(btn.dataset.size);
        });
    });

    // Configuration: Toggle result
    toggleResult.addEventListener('click', () => {
        toggleResult.classList.toggle('active');
        showResult = toggleResult.classList.contains('active');
    });

    // Start button
    startBtn.addEventListener('click', () => {
        configDialog.classList.add('hidden');
        initializeAbacus();
        abacusDisplay.classList.add('active');
        updateResultDisplay();
    });

    // Back button
    backBtn.addEventListener('click', () => {
        abacusDisplay.classList.remove('active');
        setTimeout(() => {
            configDialog.classList.remove('hidden');
        }, 300);
    });

    // Clear button
    clearBtn.addEventListener('click', () => {
        resetAbacus();
    });

    // Initialize abacus
    function initializeAbacus() {
        const abacusRods = document.getElementById('abacusRods');
        const countersRow = document.getElementById('countersRow');

        abacusRods.innerHTML = '';
        countersRow.innerHTML = '';
        columnValues = new Array(abacusSize).fill(0);

        // Calculate middle column (units position)
        const middleIndex = Math.floor(abacusSize / 2);

        for (let i = 0; i < abacusSize; i++) {
            // Create counter
            const counter = document.createElement('div');
            counter.className = 'counter';
            counter.textContent = '0';
            counter.id = `counter-${i}`;
            countersRow.appendChild(counter);

            // Create rod container
            const rodContainer = document.createElement('div');
            rodContainer.className = 'rod-container';

            // Add place value label
            const placeLabel = document.createElement('div');
            placeLabel.className = 'place-label';
            const placeValue = middleIndex - i;
            if (placeValue === 0) {
                placeLabel.textContent = 'Unități';
            } else if (placeValue === 1) {
                placeLabel.textContent = 'Zeci';
            } else if (placeValue === 2) {
                placeLabel.textContent = 'Sute';
            } else if (placeValue === 3) {
                placeLabel.textContent = 'Mii';
            } else if (placeValue === 4) {
                placeLabel.textContent = 'Zeci mii';
            } else if (placeValue === 5) {
                placeLabel.textContent = 'Sute mii';
            } else if (placeValue === 6) {
                placeLabel.textContent = 'Milioane';
            } else if (placeValue === 7) {
                placeLabel.textContent = 'Zeci mil.';
            } else if (placeValue === 8) {
                placeLabel.textContent = 'Sute mil.';
            } else if (placeValue < 0) {
                placeLabel.textContent = `1/${Math.pow(10, Math.abs(placeValue))}`;
            }
            rodContainer.appendChild(placeLabel);

            // Create rod
            const rod = document.createElement('div');
            rod.className = 'rod';

            // Top section (1 bead = 5)
            const topSection = document.createElement('div');
            topSection.className = 'beads-section top';
            const topBead = createBead(i, 5, 'top');
            topSection.appendChild(topBead);
            rod.appendChild(topSection);

            // Divider
            const divider = document.createElement('div');
            divider.className = 'divider';
            rod.appendChild(divider);

            // Bottom section (4 beads = 1 each)
            const bottomSection = document.createElement('div');
            bottomSection.className = 'beads-section bottom';
            for (let j = 0; j < 4; j++) {
                const bottomBead = createBead(i, 1, 'bottom');
                bottomSection.appendChild(bottomBead);
            }
            rod.appendChild(bottomSection);

            rodContainer.appendChild(rod);
            abacusRods.appendChild(rodContainer);
        }
    }

    // Create bead element
    function createBead(columnIndex, value, section) {
        const bead = document.createElement('div');
        bead.className = 'bead';
        bead.dataset.column = columnIndex;
        bead.dataset.value = value;
        bead.dataset.section = section;

        bead.addEventListener('click', () => {
            toggleBead(bead);
        });

        return bead;
    }

    // Toggle bead state
    function toggleBead(bead) {
        const isActive = bead.classList.contains('active');
        const columnIndex = parseInt(bead.dataset.column);
        const value = parseInt(bead.dataset.value);

        if (isActive) {
            bead.classList.remove('active');
            columnValues[columnIndex] -= value;
        } else {
            bead.classList.add('active');
            columnValues[columnIndex] += value;
        }

        // Update counter for this column
        updateCounter(columnIndex);
        updateResultDisplay();
    }

    // Update counter display
    function updateCounter(columnIndex) {
        const counter = document.getElementById(`counter-${columnIndex}`);
        counter.textContent = columnValues[columnIndex];
    }

    // Update result display
    function updateResultDisplay() {
        if (!showResult) {
            resultDisplay.textContent = 'Total: ***';
            return;
        }

        const middleIndex = Math.floor(abacusSize / 2);
        let total = 0;

        for (let i = 0; i < abacusSize; i++) {
            const placeValue = middleIndex - i;
            const multiplier = Math.pow(10, placeValue);
            total += columnValues[i] * multiplier;
        }

        resultDisplay.textContent = `Total: ${total.toLocaleString('ro-RO')}`;
    }

    // Reset abacus
    function resetAbacus() {
        const beads = document.querySelectorAll('.bead');
        beads.forEach(bead => {
            bead.classList.remove('active');
        });

        columnValues.fill(0);

        for (let i = 0; i < abacusSize; i++) {
            updateCounter(i);
        }

        updateResultDisplay();
    }
</script>
{% endblock %}
